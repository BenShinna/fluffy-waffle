import { sidebarLayoutConfig } from "../config";
import type {
	SidebarLayoutConfig,
	WidgetComponentConfig,
	WidgetComponentType,
} from "../types/config";

/**
 * ç»„ä»¶æ˜ å°„è¡¨ - å°†ç»„ä»¶ç±»å‹æ˜ å°„åˆ°å®é™…çš„ç»„ä»¶è·¯å¾„
 */
export const WIDGET_COMPONENT_MAP = {
	profile: "../components/widget/Profile.astro",
	announcement: "../components/widget/Announcement.astro",
	categories: "../components/widget/Categories.astro",
	tags: "../components/widget/Tags.astro",
	toc: "../components/widget/TOC.astro",
	"music-player": "../components/widget/MusicPlayer.svelte",
	pio: "../components/widget/Pio.astro", // æ·»åŠ  Pio ç»„ä»¶æ˜ å°„
import { sidebarLayoutConfig } from "../config";
import type {
	SidebarLayoutConfig,
	WidgetComponentConfig,
	WidgetComponentType,
} from "../types/config";

/**
 * ç»„ä»¶æ˜ å°„è¡¨ - å°†ç»„ä»¶ç±»å‹æ˜ å°„åˆ°å®é™…çš„ç»„ä»¶è·¯å¾„
 */
export const WIDGET_COMPONENT_MAP = {
	profile: "../components/widget/Profile.astro",
	announcement: "../components/widget/Announcement.astro",
	categories: "../components/widget/Categories.astro",
	tags: "../components/widget/Tags.astro",
	toc: "../components/widget/TOC.astro",
	"music-player": "../components/widget/MusicPlayer.svelte",
	pio: "../components/widget/Pio.astro", // æ·»åŠ  Pio ç»„ä»¶æ˜ å°„
	"site-stats": "../components/widget/SiteStats.astro", // ç«™ç‚¹ç»Ÿè®¡ç»„ä»¶
	calendar: "../components/widget/Calendar.astro", // æ—¥å†ç»„ä»¶
	custom: null, // è‡ªå®šä¹‰ç»„ä»¶éœ€è¦åœ¨é…ç½®ä¸­æŒ‡å®šè·¯å¾„
} as const;

/**
 * ç»„ä»¶ç®¡ç†å™¨ç±»
 * è´Ÿè´£ç®¡ç†ä¾§è¾¹æ ç»„ä»¶çš„åŠ¨æ€åŠ è½½ã€æ’åºå’Œæ¸²æŸ“
 */
export class WidgetManager {
	private config: SidebarLayoutConfig;

	constructor(config: SidebarLayoutConfig = sidebarLayoutConfig) {
		this.config = config;
	}

	/**
	 * è·å–é…ç½®
	 */
	getConfig(): SidebarLayoutConfig {
		return this.config;
	}

	/**
	 * æ ¹æ®ä½ç½®è·å–ç»„ä»¶åˆ—è¡¨
	 * @param position ç»„ä»¶ä½ç½®ï¼š'top' | 'sticky'
	 * @param sidebar ä¾§è¾¹æ ä½ç½®ï¼ˆå¯é€‰ï¼‰ï¼š'left' | 'right' | 'drawer'
	 * @param deviceType è®¾å¤‡ç±»å‹ï¼ˆå¯é€‰ï¼‰ï¼š'mobile' | 'tablet' | 'desktop'
	 */
	getComponentsByPosition(
		position: "top" | "sticky",
		sidebar: "left" | "right" | "drawer" = "left",
		deviceType: "mobile" | "tablet" | "desktop" = "desktop",
	): WidgetComponentConfig[] {
		let activeSidebar = sidebar;

		// æ‰‹æœºç«¯é€»è¾‘ï¼šå®Œå…¨ç”± drawer å†³å®šï¼Œä¸åˆå¹¶å·¦å³ä¾§æ 
		if (deviceType === "mobile") {
			activeSidebar = "drawer";
		}
		// å¹³æ¿ç«¯é€»è¾‘ï¼šåœ¨å·¦ä¾§æœ‰é…ç½®ç»„ä»¶çš„æƒ…å†µä¸‹ä»…ä¿ç•™å·¦ä¾§ç»„ä»¶ï¼Œå·¦ä¾§æ²¡æœ‰é…ç½®ç»„ä»¶æ—¶åˆ™å°†å³ä¾§çš„ç»„ä»¶ç§»åˆ°å·¦ä¾§
		else if (deviceType === "tablet") {
			if (sidebar === "right") {
				return [];
			}
			if (sidebar === "left") {
				activeSidebar =
					this.config.components.left.length > 0 ? "left" : "right";
			}
		}

		// ğŸ‘‡ ä¿®å¤ï¼šç¡®ä¿æ°¸è¿œæ˜¯æ•°ç»„ï¼Œä¸ä¼š undefined
		const componentTypes = this.config.components[activeSidebar] ?? [];

		return componentTypes
			.map((type) => {
				const prop = this.config.properties.find((p) => p.type === type);
				if (prop && prop.position === position) {
					return prop;
				}
				// å¦‚æœæ²¡æœ‰åœ¨ properties ä¸­æ‰¾åˆ°é…ç½®ï¼Œä¸”ä½ç½®åŒ¹é…é»˜è®¤çš„ topï¼Œåˆ™è¿”å›ä¸€ä¸ªåŸºç¡€é…ç½®
				if (!prop && position === "top") {
					return { type, position: "top" } as WidgetComponentConfig;
				}
				return null;
			})
			.filter((item): item is WidgetComponentConfig => item !== null);
	}

	/**
	 * è·å–ç»„ä»¶çš„åŠ¨ç”»å»¶è¿Ÿæ—¶é—´
	 * @param component ç»„ä»¶é…ç½®
	 * @param index ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
	 */
	getAnimationDelay(component: WidgetComponentConfig, index: number): number {
		if (component.animationDelay !== undefined) {
			return component.animationDelay;
		}

		if (this.config.defaultAnimation.enable) {
			return (
				this.config.defaultAnimation.baseDelay +
				index * this.config.defaultAnimation.increment
			);
		}

		return 0;
	}

	/**
	 * è·å–ç»„ä»¶çš„CSSç±»å
	 * @param component ç»„ä»¶é…ç½®
	 * @param index ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
	 */
	getComponentClass(
		component: WidgetComponentConfig,
		_index: number,
	): string {
		const classes: string[] = [];

		// æ·»åŠ åŸºç¡€ç±»å
		if (component.class) {
			classes.push(component.class);
		}

		// æ·»åŠ å“åº”å¼éšè—ç±»å
		if (component.responsive?.hidden) {
			component.responsive.hidden.forEach((device) => {
				switch (device) {
					case "mobile":
						classes.push("hidden", "md:block");
						break;
					case "tablet":
						classes.push("md:hidden", "lg:block");
						break;
					case "desktop":
						classes.push("lg:hidden");
						break;
				}
			});
		}

		return classes.join(" ");
	}

	/**
	 * è·å–ç»„ä»¶çš„å†…è”æ ·å¼
	 * @param component ç»„ä»¶é…ç½®
	 * @param index ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
	 */
	getComponentStyle(component: WidgetComponentConfig, index: number): string {
		const styles: string[] = [];

		// æ·»åŠ è‡ªå®šä¹‰æ ·å¼
		if (component.style) {
			styles.push(component.style);
		}

		// æ·»åŠ åŠ¨ç”»å»¶è¿Ÿæ ·å¼
		const animationDelay = this.getAnimationDelay(component, index);
		if (animationDelay > 0) {
			styles.push(`animation-delay: ${animationDelay}ms`);
		}

		return styles.join("; ");
	}

	/**
	 * æ£€æŸ¥ç»„ä»¶æ˜¯å¦åº”è¯¥æŠ˜å 
	 * @param component ç»„ä»¶é…ç½®
	 * @param itemCount ç»„ä»¶å†…å®¹é¡¹æ•°é‡
	 */
	isCollapsed(component: WidgetComponentConfig, itemCount: number): boolean {
		if (!component.responsive?.collapseThreshold) {
			return false;
		}
		return itemCount >= component.responsive.collapseThreshold;
	}

	/**
	 * è·å–ç»„ä»¶çš„è·¯å¾„
	 * @param componentType ç»„ä»¶ç±»å‹
	 */
	getComponentPath(componentType: WidgetComponentType): string | null {
		return WIDGET_COMPONENT_MAP[componentType];
	}

	/**
	 * æ£€æŸ¥å½“å‰è®¾å¤‡æ˜¯å¦åº”è¯¥æ˜¾ç¤ºä¾§è¾¹æ 
	 * @param deviceType è®¾å¤‡ç±»å‹
	 */
	shouldShowSidebar(deviceType: "mobile" | "tablet" | "desktop"): boolean {
		if (deviceType === "mobile") {
			return this.config.components.drawer.length > 0;
		}
		if (deviceType === "tablet") {
			return (
				this.config.components.left.length > 0 ||
				this.config.components.right.length > 0
			);
		}
		// desktop
		return (
			this.config.components.left.length > 0 ||
			this.config.components.right.length > 0
		);
	}

	/**
	 * è·å–è®¾å¤‡æ–­ç‚¹é…ç½®
	 */
	getBreakpoints() {
		return this.config.responsive.breakpoints;
	}

	/**
	 * æ›´æ–°ç»„ä»¶é…ç½®
	 * @param newConfig æ–°çš„é…ç½®
	 */
	updateConfig(newConfig: Partial<SidebarLayoutConfig>): void {
		this.config = { ...this.config, ...newConfig };
	}

	/**
	 * æ·»åŠ æ–°ç»„ä»¶åˆ°å¸ƒå±€ä¸­
	 * @param type ç»„ä»¶ç±»å‹
	 * @param sidebar ä¾§è¾¹æ ä½ç½®
	 */
	addComponentToLayout(
		type: WidgetComponentType,
		sidebar: "left" | "right" | "drawer" = "left",
	): void {
		if (!this.config.components[sidebar].includes(type)) {
			this.config.components[sidebar].push(type);
		}
	}

	/**
	 * ä»å¸ƒå±€ä¸­ç§»é™¤ç»„ä»¶
	 * @param type ç»„ä»¶ç±»å‹
	 */
	removeComponentFromLayout(type: WidgetComponentType): void {
		this.config.components.left = this.config.components.left.filter(
			(t) => t !== type,
		);
		this.config.components.right = this.config.components.right.filter(
			(t) => t !== type,
		);
		this.config.components.drawer = this.config.components.drawer.filter(
			(t) => t !== type,
		);
	}

	/**
	 * æ£€æŸ¥ç»„ä»¶æ˜¯å¦åº”è¯¥åœ¨ä¾§è¾¹æ ä¸­æ¸²æŸ“
	 * @param componentType ç»„ä»¶ç±»å‹
	 */
	isSidebarComponent(componentType: WidgetComponentType): boolean {
		// Pio ç»„ä»¶æ˜¯å…¨å±€ç»„ä»¶ï¼Œä¸åœ¨ä¾§è¾¹æ ä¸­æ¸²æŸ“
		return componentType !== "pio";
	}
}

/**
 * é»˜è®¤ç»„ä»¶ç®¡ç†å™¨å®ä¾‹
 */
export const widgetManager = new WidgetManager();

/**
 * å·¥å…·å‡½æ•°ï¼šæ ¹æ®ç»„ä»¶ç±»å‹è·å–ç»„ä»¶é…ç½®
 * @param componentType ç»„ä»¶ç±»å‹
 */
export function getComponentConfig(
	componentType: WidgetComponentType,
): WidgetComponentConfig | undefined {
	return widgetManager
		.getConfig()
		.properties.find((p) => p.type === componentType);
}

/**
 * å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦å¯ç”¨
 * @param componentType ç»„ä»¶ç±»å‹
 */
export function isComponentEnabled(
	componentType: WidgetComponentType,
): boolean {
	const config = widgetManager.getConfig().components;
	return (
		config.left.includes(componentType) ||
		config.right.includes(componentType) ||
		config.drawer.includes(componentType)
	);
}

/**
 * å·¥å…·å‡½æ•°ï¼šè·å–æ‰€æœ‰å¯ç”¨çš„ç»„ä»¶ç±»å‹(å·¦ä¾§è¾¹æ ä¸ºä¸»)
 */
export function getEnabledComponentTypes(): WidgetComponentType[] {
	return widgetManager.getConfig().components.left;
}

	calendar: "../components/widget/Calendar.astro", // æ—¥å†ç»„ä»¶
	custom: null, // è‡ªå®šä¹‰ç»„ä»¶éœ€è¦åœ¨é…ç½®ä¸­æŒ‡å®šè·¯å¾„
} as const;

/**
 * ç»„ä»¶ç®¡ç†å™¨ç±»
 * è´Ÿè´£ç®¡ç†ä¾§è¾¹æ ç»„ä»¶çš„åŠ¨æ€åŠ è½½ã€æ’åºå’Œæ¸²æŸ“
 */
export class WidgetManager {
	private config: SidebarLayoutConfig;

	constructor(config: SidebarLayoutConfig = sidebarLayoutConfig) {
		this.config = config;


	/**
	 * è·å–é…ç½®
	 */
	getConfig(): SidebarLayoutConfig {
		return this.config;
	}

	/**
	 * æ ¹æ®ä½ç½®è·å–ç»„ä»¶åˆ—è¡¨
	 * @param position ç»„ä»¶ä½ç½®ï¼š'top' | 'sticky'
	 * @param sidebar ä¾§è¾¹æ ä½ç½®ï¼ˆå¯é€‰ï¼‰ï¼š'left' | 'right' | 'drawer'
	 * @param deviceType è®¾å¤‡ç±»å‹ï¼ˆå¯é€‰ï¼‰ï¼š'mobile' | 'tablet' | 'desktop'
	 */
	getComponentsByPosition(
		position: "top" | "sticky",
		sidebar: "left" | "right" | "drawer" = "left",
		deviceType: "mobile" | "tablet" | "desktop" = "desktop",
	): WidgetComponentConfig[] {
		let activeSidebar = sidebar;

		// æ‰‹æœºç«¯é€»è¾‘ï¼šå®Œå…¨ç”± drawer å†³å®šï¼Œä¸åˆå¹¶å·¦å³ä¾§æ 
		if (deviceType === "mobile") {
			activeSidebar = "drawer";
		}
		// å¹³æ¿ç«¯é€»è¾‘ï¼šåœ¨å·¦ä¾§æœ‰é…ç½®ç»„ä»¶çš„æƒ…å†µä¸‹ä»…ä¿ç•™å·¦ä¾§ç»„ä»¶ï¼Œå·¦ä¾§æ²¡æœ‰é…ç½®ç»„ä»¶æ—¶åˆ™å°†å³ä¾§çš„ç»„ä»¶ç§»åˆ°å·¦ä¾§
		else if (deviceType === "tablet") {
			if (sidebar === "right") {
				return [];
			}
			if (sidebar === "left") {
				activeSidebar =
					this.config.components.left.length > 0 ? "left" : "right";
			}
		}

		const componentTypes = this.config.components[activeSidebar] || [];

		return componentTypes
			.map((type) => {
				const prop = this.config.properties.find((p) => p.type === type);
				if (prop && prop.position === position) {
					return prop;
				}
				// å¦‚æœæ²¡æœ‰åœ¨ properties ä¸­æ‰¾åˆ°é…ç½®ï¼Œä¸”ä½ç½®åŒ¹é…é»˜è®¤çš„ topï¼Œåˆ™è¿”å›ä¸€ä¸ªåŸºç¡€é…ç½®
				if (!prop && position === "top") {
					return { type, position: "top" } as WidgetComponentConfig;
				}
				return null;
			})
			.filter(Boolean) as WidgetComponentConfig[];
	}

	/**
	 * è·å–ç»„ä»¶çš„åŠ¨ç”»å»¶è¿Ÿæ—¶é—´
	 * @param component ç»„ä»¶é…ç½®
	 * @param index ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
	 */
	getAnimationDelay(component: WidgetComponentConfig, index: number): number {
		if (component.animationDelay !== undefined) {
			return component.animationDelay;
		}

		if (this.config.defaultAnimation.enable) {
			return (
				this.config.defaultAnimation.baseDelay +
				index * this.config.defaultAnimation.increment
			);
		}

		return 0;
	}

	/**
	 * è·å–ç»„ä»¶çš„CSSç±»å
	 * @param component ç»„ä»¶é…ç½®
	 * @param index ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
	 */
	getComponentClass(
		component: WidgetComponentConfig,
		_index: number,
	): string {
		const classes: string[] = [];

		// æ·»åŠ åŸºç¡€ç±»å
		if (component.class) {
			classes.push(component.class);
		}

		// æ·»åŠ å“åº”å¼éšè—ç±»å
		if (component.responsive?.hidden) {
			component.responsive.hidden.forEach((device) => {
				switch (device) {
					case "mobile":
						classes.push("hidden", "md:block");
						break;
					case "tablet":
						classes.push("md:hidden", "lg:block");
						break;
					case "desktop":
						classes.push("lg:hidden");
						break;
				}
			});
		}

		return classes.join(" ");
	}

	/**
	 * è·å–ç»„ä»¶çš„å†…è”æ ·å¼
	 * @param component ç»„ä»¶é…ç½®
	 * @param index ç»„ä»¶åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
	 */
	getComponentStyle(component: WidgetComponentConfig, index: number): string {
		const styles: string[] = [];

		// æ·»åŠ è‡ªå®šä¹‰æ ·å¼
		if (component.style) {
			styles.push(component.style);
		}

		// æ·»åŠ åŠ¨ç”»å»¶è¿Ÿæ ·å¼
		const animationDelay = this.getAnimationDelay(component, index);
		if (animationDelay > 0) {
			styles.push(`animation-delay: ${animationDelay}ms`);
		}

		return styles.join("; ");
	}

	/**
	 * æ£€æŸ¥ç»„ä»¶æ˜¯å¦åº”è¯¥æŠ˜å 
	 * @param component ç»„ä»¶é…ç½®
	 * @param itemCount ç»„ä»¶å†…å®¹é¡¹æ•°é‡
	 */
	isCollapsed(component: WidgetComponentConfig, itemCount: number): boolean {
		if (!component.responsive?.collapseThreshold) {
			return false;
		}
		return itemCount >= component.responsive.collapseThreshold;
	}

	/**
	 * è·å–ç»„ä»¶çš„è·¯å¾„
	 * @param componentType ç»„ä»¶ç±»å‹
	 */
	getComponentPath(componentType: WidgetComponentType): string | null {
		return WIDGET_COMPONENT_MAP[componentType];
	}

	/**
	 * æ£€æŸ¥å½“å‰è®¾å¤‡æ˜¯å¦åº”è¯¥æ˜¾ç¤ºä¾§è¾¹æ 
	 * @param deviceType è®¾å¤‡ç±»å‹
	 */
	shouldShowSidebar(deviceType: "mobile" | "tablet" | "desktop"): boolean {
		if (deviceType === "mobile") {
			return this.config.components.drawer.length > 0;
		}
		if (deviceType === "tablet") {
			return (
				this.config.components.left.length > 0 ||
				this.config.components.right.length > 0
			);
		}
		// desktop
		return (
			this.config.components.left.length > 0 ||
			this.config.components.right.length > 0
		);
	}

	/**
	 * è·å–è®¾å¤‡æ–­ç‚¹é…ç½®
	 */
	getBreakpoints() {
		return this.config.responsive.breakpoints;
	}

	/**
	 * æ›´æ–°ç»„ä»¶é…ç½®
	 * @param newConfig æ–°çš„é…ç½®
	 */
	updateConfig(newConfig: Partial<SidebarLayoutConfig>): void {
		this.config = { ...this.config, ...newConfig };
	}

	/**
	 * æ·»åŠ æ–°ç»„ä»¶åˆ°å¸ƒå±€ä¸­
	 * @param type ç»„ä»¶ç±»å‹
	 * @param sidebar ä¾§è¾¹æ ä½ç½®
	 */
	addComponentToLayout(
		type: WidgetComponentType,
		sidebar: "left" | "right" | "drawer" = "left",
	): void {
		if (!this.config.components[sidebar].includes(type)) {
			this.config.components[sidebar].push(type);
		}
	}

	/**
	 * ä»å¸ƒå±€ä¸­ç§»é™¤ç»„ä»¶
	 * @param type ç»„ä»¶ç±»å‹
	 */
	removeComponentFromLayout(type: WidgetComponentType): void {
		this.config.components.left = this.config.components.left.filter(
			(t) => t !== type,
		);
		this.config.components.right = this.config.components.right.filter(
			(t) => t !== type,
		);
		this.config.components.drawer = this.config.components.drawer.filter(
			(t) => t !== type,
		);
	}

	/**
	 * æ£€æŸ¥ç»„ä»¶æ˜¯å¦åº”è¯¥åœ¨ä¾§è¾¹æ ä¸­æ¸²æŸ“
	 * @param componentType ç»„ä»¶ç±»å‹
	 */
	isSidebarComponent(componentType: WidgetComponentType): boolean {
		// Pio ç»„ä»¶æ˜¯å…¨å±€ç»„ä»¶ï¼Œä¸åœ¨ä¾§è¾¹æ ä¸­æ¸²æŸ“
		return componentType !== "pio";
	}
}

/**
 * é»˜è®¤ç»„ä»¶ç®¡ç†å™¨å®ä¾‹
 */
export const widgetManager = new WidgetManager();

/**
 * å·¥å…·å‡½æ•°ï¼šæ ¹æ®ç»„ä»¶ç±»å‹è·å–ç»„ä»¶é…ç½®
 * @param componentType ç»„ä»¶ç±»å‹
 */
export function getComponentConfig(
	componentType: WidgetComponentType,
): WidgetComponentConfig | undefined {
	return widgetManager
		.getConfig()
		.properties.find((p) => p.type === componentType);
}

/**
 * å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦å¯ç”¨
 * @param componentType ç»„ä»¶ç±»å‹
 */
export function isComponentEnabled(
	componentType: WidgetComponentType,
): boolean {
	const config = widgetManager.getConfig().components;
	return (
		config.left.includes(componentType) ||
		config.right.includes(componentType) ||
		config.drawer.includes(componentType)
	);
}

/**
 * å·¥å…·å‡½æ•°ï¼šè·å–æ‰€æœ‰å¯ç”¨çš„ç»„ä»¶ç±»å‹(å·¦ä¾§è¾¹æ ä¸ºä¸»)
 */
export function getEnabledComponentTypes(): WidgetComponentType[] {
	return widgetManager.getConfig().components.left;
}
